name: PR è‡ªåŠ¨å®¡æŸ¥ä¸åˆ†æµ

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  pr-flow:
    name: PR è‡ªåŠ¨åŒ–æµç¨‹
    runs-on: ubuntu-latest

    steps:
      - name: åˆå§‹è¯„è®º - æ­£åœ¨è¿›è¡Œè‡ªåŠ¨åŒ–å®¡æŸ¥
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;

            // è·å– PR å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner, repo, pull_number: number, per_page: 100
            });

            const fileList = files.map(f => `- \`${f.filename}\` (${f.status})`).join('\n');
            const fileCount = files.length;

            await github.rest.issues.createComment({
              owner, repo, issue_number: number,
              body: `âš  æœ¬ PR å·²è¿›å…¥è‡ªåŠ¨åŒ–å®¡æŸ¥æµç¨‹ï¼Œæ­£åœ¨è¿›è¡Œä»£ç å®¡æŸ¥ï¼Œè¯·ç¨å\n\n**æœ¬æ¬¡å˜æ›´æ–‡ä»¶ (${fileCount} ä¸ª):**\n${fileList}\n\næ­£åœ¨è¿›è¡Œå˜æ›´ç±»å‹è¯†åˆ«ä¸ TypeScript è¯­æ³•æ£€æŸ¥...`
            });

      - name: æ£€å‡º PR æäº¤ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: è¯†åˆ«æ˜¯å¦ä»…ä¿®æ”¹æ–‡æ¡£
        id: flags
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const files = await github.paginate(github.rest.pulls.listFiles, { owner, repo, pull_number: number, per_page: 100 });
            const isDoc = (f) => {
              const n = f.filename.toLowerCase();
              return n.endsWith('.md') || n.endsWith('.mdx') || n.endsWith('.txt') || n.startsWith('docs/');
            };
            const docsOnly = files.length > 0 && files.every(isDoc);
            core.setOutput('docs_only', String(docsOnly));

      - name: ä»…æ–‡æ¡£å˜æ›´ - å›å¤
        if: ${{ steps.flags.outputs.docs_only == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            await github.rest.issues.createComment({
              owner, repo, issue_number: number,
              body: 'ğŸ“ æœ¬æ¬¡æäº¤ä»…ä¸ºçº¯æ–‡æ¡£/æ–‡æœ¬å˜æ›´ã€‚è¯·ç­‰å¾…ä½œè€…æœ€ç»ˆå®¡æ ¸ã€‚'
            });



      - name: è®¾ç½® Node ç‰ˆæœ¬
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…ä¾èµ–ï¼ˆserverï¼‰
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        run: |
          cd server
          npm ci --ignore-scripts

      - name: TypeScript è¯­æ³•æ£€æŸ¥ï¼ˆserverï¼‰
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        id: tsc_server
        shell: bash
        run: |
          set +e
          cd server
          npx tsc --noEmit 2>&1 | tee ../tsc_server_output.txt
          rc=$?
          cd ..
          if [ $rc -ne 0 ]; then echo "failed=true" >> $GITHUB_OUTPUT; else echo "failed=false" >> $GITHUB_OUTPUT; fi
          exit 0

      - name: å®‰è£…ä¾èµ–ï¼ˆclientï¼‰
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        run: |
          cd client
          npm ci --ignore-scripts

      - name: TypeScript è¯­æ³•æ£€æŸ¥ï¼ˆclientï¼‰
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        id: tsc_client
        shell: bash
        run: |
          set +e
          cd client
          npx tsc --noEmit 2>&1 | tee ../tsc_client_output.txt
          rc=$?
          cd ..
          if [ $rc -ne 0 ]; then echo "failed=true" >> $GITHUB_OUTPUT; else echo "failed=false" >> $GITHUB_OUTPUT; fi
          exit 0

      - name: ç±»å‹æ£€æŸ¥å¤±è´¥æ—¶å›å¤ PR
        if: ${{ (steps.tsc_server.outputs.failed == 'true' || steps.tsc_client.outputs.failed == 'true') && steps.flags.outputs.docs_only != 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const fs = require('fs');

            let errorDetails = '';

            // è¯»å– server ç«¯é”™è¯¯ä¿¡æ¯
            if ('${{ steps.tsc_server.outputs.failed }}' === 'true') {
              try {
                const serverErrors = fs.readFileSync('tsc_server_output.txt', 'utf8');
                if (serverErrors.trim()) {
                  errorDetails += '**Server ç«¯ç±»å‹é”™è¯¯:**\n```\n' + serverErrors.trim() + '\n```\n\n';
                }
              } catch (e) {
                errorDetails += '**Server ç«¯ç±»å‹æ£€æŸ¥å¤±è´¥**ï¼ˆæ— æ³•è¯»å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼‰\n\n';
              }
            }

            // è¯»å– client ç«¯é”™è¯¯ä¿¡æ¯
            if ('${{ steps.tsc_client.outputs.failed }}' === 'true') {
              try {
                const clientErrors = fs.readFileSync('tsc_client_output.txt', 'utf8');
                if (clientErrors.trim()) {
                  errorDetails += '**Client ç«¯ç±»å‹é”™è¯¯:**\n```\n' + clientErrors.trim() + '\n```\n\n';
                }
              } catch (e) {
                errorDetails += '**Client ç«¯ç±»å‹æ£€æŸ¥å¤±è´¥**ï¼ˆæ— æ³•è¯»å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼‰\n\n';
              }
            }

            await github.rest.issues.createComment({
              owner, repo, issue_number: number,
              body: `âŒ è‡ªåŠ¨åŒ–ç±»å‹æ£€æŸ¥æœªé€šè¿‡ã€‚å‘½ä»¤ï¼š\`npx tsc --noEmit\`\n\n${errorDetails}è¯·æ ¹æ®ä¸Šè¿°é”™è¯¯ä¿¡æ¯ä¿®å¤ç±»å‹é”™è¯¯åå†æ¬¡æäº¤ï¼Œç³»ç»Ÿä¼šé‡æ–°å®¡æŸ¥ï½`
            });

      - name: ç¡®ä¿ base ä»“åº“å­˜åœ¨ feature åˆ†æ”¯
        if: ${{ success() && steps.flags.outputs.docs_only != 'true' && steps.tsc_server.outputs.failed != 'true' && steps.tsc_client.outputs.failed != 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTIONS_PAT }}
          script: |
            const { owner, repo } = context.issue;
            async function ensureFeature() {
              try {
                await github.rest.git.getRef({ owner, repo, ref: 'heads/feature' });
              } catch (err) {
                if (err.status === 404) {
                  const baseRef = await github.rest.git.getRef({ owner, repo, ref: 'heads/main' });
                  await github.rest.git.createRef({ owner, repo, ref: 'refs/heads/feature', sha: baseRef.data.object.sha });
                } else {
                  throw err;
                }
              }
            }
            await ensureFeature();

      - name: å¦‚ç›®æ ‡ä¸º mainï¼Œåˆ™å°† PR ç›®æ ‡åˆ†æ”¯åˆ‡æ¢ä¸º feature
        if: ${{ success() && steps.flags.outputs.docs_only != 'true' && steps.tsc_server.outputs.failed != 'true' && steps.tsc_client.outputs.failed != 'true' && github.event.pull_request.base.ref == 'main' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTIONS_PAT }}
          script: |
            const { owner, repo, number } = context.issue;
            await github.rest.pulls.update({ owner, repo, pull_number: number, base: 'feature' });

      - name: åˆå¹¶ PRï¼ˆç›®æ ‡ä¸º feature æ—¶ç›´æ¥åˆå¹¶ï¼‰
        if: ${{ success() && steps.flags.outputs.docs_only != 'true' && steps.tsc_server.outputs.failed != 'true' && steps.tsc_client.outputs.failed != 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTIONS_PAT }}
          script: |
            const { owner, repo, number } = context.issue;
            try {
              const pr = await github.rest.pulls.get({ owner, repo, pull_number: number });
              if (pr.data.state !== 'open') {
                return await github.rest.issues.createComment({ owner, repo, issue_number: number, body: 'âš ï¸ PR å½“å‰é open çŠ¶æ€ï¼Œè‡ªåŠ¨åˆå¹¶å·²è·³è¿‡ã€‚' });
              }
              await github.rest.pulls.merge({ owner, repo, pull_number: number, merge_method: 'merge' });
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: 'âœ… æ‚¨çš„ PR å·²é€šè¿‡è‡ªåŠ¨åŒ–æ£€æŸ¥ï¼Œç°å·²åˆå¹¶è‡³ featureæµ‹è¯•åˆ†æ”¯ã€‚\nç»´æŠ¤è€…å°†è¿›è¡Œæœ€ç»ˆæ£€æŸ¥ï¼Œè‹¥æ— é—®é¢˜ä¼šåˆå¹¶åˆ° main åˆ†æ”¯å¹¶åœ¨ä¸‹ä¸ªç‰ˆæœ¬å‘å¸ƒæ—¶åŒ…å«ã€‚æ„Ÿè°¢è´¡çŒ®ï¼â¤'
              });
            } catch (e) {
              const msg = (e && e.message) ? e.message : String(e);
              await github.rest.issues.createComment({ owner, repo, issue_number: number, body: `âš ï¸ è‡ªåŠ¨åˆå¹¶å¤±è´¥ï¼Œè¯·ç»´æŠ¤è€…æŸ¥çœ‹ï¼š\n\n\`\`\`\n${msg}\n\`\`\`` });
              core.setFailed('Auto merge failed');
            }

