name: æ ‡å‡†åŒæ­¥mainåˆ†æ”¯åˆ°featureåˆ†æ”¯

on:
  push:
    branches:
      - main

jobs:
  sync-to-feature:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²
          token: ${{ secrets.ACTIONS_PAT }}
      
      - name: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
      
      - name: åŒæ­¥åˆ°featureåˆ†æ”¯
        run: |
          # æ£€æŸ¥featureåˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --heads origin feature | grep -q feature; then
            echo "featureåˆ†æ”¯å­˜åœ¨ï¼Œå¼€å§‹åŒæ­¥"
            # åˆ‡æ¢åˆ°featureåˆ†æ”¯
            git fetch origin feature
            git checkout -b feature origin/feature

            # å°è¯•åˆå¹¶mainåˆ†æ”¯
            echo "æ­£åœ¨å°†mainåˆ†æ”¯åˆå¹¶åˆ°featureåˆ†æ”¯..."
            if git merge origin/main --no-edit; then
              echo "âœ… åˆå¹¶æˆåŠŸï¼Œæ¨é€åˆ°è¿œç¨‹ä»“åº“"
              git push origin feature
            else
              echo "âŒ åˆå¹¶å†²çªdetectedï¼"
              echo "å†²çªæ–‡ä»¶åˆ—è¡¨ï¼š"
              git status --porcelain | grep "^UU\|^AA\|^DD" || echo "æ— æ³•ç¡®å®šå†²çªæ–‡ä»¶"
              echo ""
              echo "è¯·æ‰‹åŠ¨è§£å†³å†²çªåå†æ¬¡æ¨é€åˆ°mainåˆ†æ”¯"
              echo "æˆ–è€…è”ç³»ä»“åº“ç»´æŠ¤è€…å¤„ç†å†²çª"
              exit 1
            fi
          else
            echo "featureåˆ†æ”¯ä¸å­˜åœ¨ï¼Œä»mainåˆ†æ”¯åˆ›å»º"
            git checkout -b feature
            git push origin feature --set-upstream
            echo "âœ… æˆåŠŸåˆ›å»ºfeatureåˆ†æ”¯"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_PAT }}

      - name: è¾“å‡ºåŒæ­¥ç»“æœ
        if: success()
        run: |
          echo "âœ… æˆåŠŸå°†mainåˆ†æ”¯åŒæ­¥åˆ°featureåˆ†æ”¯"
          echo "ğŸ“ åŒæ­¥çš„æäº¤: ${{ github.sha }}"
          echo "ğŸ‘¤ æ¨é€è€…: ${{ github.actor }}"
          echo "ğŸ”„ åŒæ­¥æ–¹å¼: æ ‡å‡†åˆå¹¶ï¼ˆéå¼ºåˆ¶æ¨é€ï¼‰"

      - name: å†²çªå¤„ç†æç¤º
        if: failure()
        run: |
          echo "âš ï¸  åŒæ­¥å¤±è´¥ - æ£€æµ‹åˆ°åˆå¹¶å†²çª"
          echo "ğŸ”§ è§£å†³æ–¹æ¡ˆï¼š"
          echo "1. æœ¬åœ°å…‹éš†ä»“åº“"
          echo "2. åˆ‡æ¢åˆ°featureåˆ†æ”¯: git checkout feature"
          echo "3. åˆå¹¶mainåˆ†æ”¯: git merge main"
          echo "4. æ‰‹åŠ¨è§£å†³å†²çªæ–‡ä»¶"
          echo "5. æäº¤è§£å†³ç»“æœ: git commit"
          echo "6. æ¨é€åˆ°è¿œç¨‹: git push origin feature"
